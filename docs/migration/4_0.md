# Technical Changes in Spartacus 4.0

## Breaking Changes Introduced in 4.0

### SavedCartDetailsActionComponent
 - Removed `ClearCheckoutService` from constructor.

### SavedCartListComponent
- Removed `ClearCheckoutService` from constructor.

### SavedCartFormDialogComponent
- Removed `ClearCheckoutService` from constructor.

## ConfiguratorCartService
Lib: @spartacus/product-configurator
Class: ConfiguratorCartService
Change: The type of constructor parameter `checkoutService: CheckoutService` is changed to `checkoutFacade: CheckoutFacade` to adapt to the new checkout lib. 
### AddressBookComponentService
Lib: @spartacus/core
Class: AddressBookComponentService
Change: constructor parameter `checkoutDeliveryService: CheckoutDeliveryService` is removed.
It is replaced with new constructor parameter `eventService: EventService`.

Since the reference to `CheckoutDeliveryService` is removed, the `AddressBookComponentService` fires events when an address is changed.

Address data update fires event: `UserAddressUpdateEvent`.
Setting an address as default fires: `UserAddressSetToDefaultEvent`.
Deleting an address fires event: `UserAddressDeleteEvent`.

All these events have the same parent class `UserAddressChangeEvent`.

### AddressBookComponent
Lib: @spartacus/core
Class: AddressBookComponent
Change: Two constructor parameters are removed.  First the constructor parameter `checkoutDeliveryService: CheckoutDeliveryService` is removed.
AddressBookComponent does not call `CheckoutDeliveryService.clearCheckoutDeliveryDetails()` anymore when an address is changed.  Instead, `AddressBookComponentService` fires events.  See `AddressBookComponentService` migration doc.

The second constructor parameters removed is `userAddressService: UserAddressService`. `UserAddressService` interactions are now encapsulated in `AddressBookComponentService`.


### AddressFormComponent
Lib: @spartacus/core
Class: AddressFormComponent
Change: constructor parameter `checkoutDeliveryService: CheckoutDeliveryService` is removed.
AddressFormComponent now uses the new address verification function from  `UserAddressService` called `verifyAddress` instead of the `verifyAddress` function from `CheckoutDeliveryService`.  `UserAddressService.verifyAddress` does not use the ngrx store under the hood.


### UserAddressService
Lib: @spartacus/core
Class: UserAddressService
Change: Two new required constructor parameters `userAddressConnector: UserAddressConnector` and `command: CommandService`

## (start) Changes in the classes carried over to the @spartacus/checkout lib 

### CheckoutEventModule
Class: CheckoutEventModule
Change: One new required constructor parameters `_checkoutEventListener: CheckoutEventListener`

### PaymentFormComponent
Class: PaymentFormComponent
Changes: 
- PaymentFormComponent does not implement `OnDestroy` anymore
- method `ngOnDestroy()` removed.
- Address verification uses new `UserAddressService.verifyAddress` function instead of `CheckoutDeliveryService.verifyAddress`. 

To split out the checkout code in the checkout lib, the address verification functionality
was moved in `UserAddressService` in @spartacus/core.  The address verification related functions in `CheckoutDeliveryService` and ngrx supporting classes are not present in the checkout lib.

### CheckoutDeliveryService:
These functions are not present in the checkout lib:
- `getAddressVerificationResults(): Observable<AddressValidation | string>`
- `verifyAddress(address: Address): void`
- `clearAddressVerificationResults(): void`

These functions are also not present in the corresponding facade `CheckoutDeliveryFacade`

### CheckoutState
Property `addressVerification: AddressVerificationState` is removed froom the `CheckoutState` class in the checkout lib.

### AddressVerificationState
The `AddressVerificationState` class is not carried over to the checkout lib.

### CheckoutDeliveryService
New property `processStateStore: Store<StateWithCheckout>` is added into the constructor.

### CheckoutPaymentService
New property `processStateStore: Store<StateWithCheckout>` is added into the constructor.

### CheckoutService
New property `processStateStore: Store<StateWithCheckout>` is added into the constructor.

### PaymentTypeService
New property `processStateStore: Store<StateWithCheckout>` is added into the constructor.

### OrderConfirmationItemsComponent
constructor parameter `PromotionService` changed to `CheckoutPromotionService`

### (end) Changes in the classes carried over to the @spartacus/checkout lib 




### WindowRef

- `platformId` is now required constructor dependency.

### Product configurator

`ConfiguratorCartEntryInfoComponent` now also requires `CommonConfiguratorUtilsService`.
`ConfiguratorAttributeCheckboxListComponent` now also requires `ConfiguratorAttributeQuantityService`.
`ConfiguratorAttributeDropDownComponent` now also requires `ConfiguratorAttributeQuantityService`.
`ConfiguratorAttributeRadiButtonComponent` now also requires `ConfiguratorAttributeQuantityService`.
`ConfiguratorStorefrontUtilsService` now also requires `KeyboardFocusService`.

### Product variants changes

#### Automated Migrations for Version 4.0

- `ProductVariantsModule` was removed from @spartacus/storefront. Use `@spartacus/product/variants` feature-library instead.
- `ProductVariantsComponent` was removed from @spartacus/storefront. Use `ProductVariantsContainerComponent` from `@spartacus/product/variants/components` as a replacement.
- `VariantColorSelectorComponent` was removed from @spartacus/storefront. Use `ProductVariantColorSelectorComponent` from `@spartacus/product/variants/components` as a replacement.
- `VariantColorSelectorModule` was removed from @spartacus/storefront. Use `ProductVariantColorSelectorModule` from `@spartacus/product/variants/components` as a replacement.
- `VariantSizeSelectorComponent` was removed from @spartacus/storefront. Use `ProductVariantSizeSelectorComponent` from `@spartacus/product/variants/components` as a replacement.
- `VariantSizeSelectorModule` was removed from @spartacus/storefront. Use `ProductVariantSizeSelectorModule` from `@spartacus/product/variants/components` as a replacement.
- `VariantStyleSelectorComponent` was removed from @spartacus/storefront. Use `ProductVariantStyleSelectorComponent` from `@spartacus/product/variants/components` as a replacement.
- `VariantStyleSelectorModule` was removed from @spartacus/storefront. Use `ProductVariantStyleSelectorModule` from `@spartacus/product/variants/components` as a replacement.
- `VariantStyleIconsComponent` was removed from @spartacus/storefront. Use `ProductVariantStyleIconsComponent` from `@spartacus/product/variants/root` as a replacement.
- `ProductVariantStyleIconsComponent` was moved from `@spartacus/product/variants/components`to `@spartacus/product/variants/root` instead.
- `VariantStyleIconsModule` was removed from @spartacus/storefront. Use `ProductVariantStyleIconsModule` from `@spartacus/product/variants/root` as a replacement.
- `ProductVariantStyleIconsModule` was moved from `@spartacus/product/variants/components`to `@spartacus/product/variants/root` instead.
- `ProductVariantGuard` was removed from @spartacus/storefront. Use `ProductVariantsGuard` from `@spartacus/product/variants/components` instead. Additionally method: `findVariant` was renamed to `findPurchasableProductCode`.

#### Product variants i18n

- translation namespace `variant` was removed from `@spartacus/assets`. Use namespace `variants` that can be imported with `productVariantsTranslations` and `productVariantsTranslationChunksConfig` from `@spartacus/product/variants/assets` instead. Translation keys from this namespace did not changed.

#### Product variants endpoint scope

- scope `variants` was removed from `defaultOccProductConfig`. It's now provided by `ProductVariantsOccModule` under `@spartacus/product/variants/occ` instead. Additionally the endpoint now uses `orgProducts` API instead of `products`.

#### Product variants styles

- styles for `cx-product-variants` were removed from `@spartacus/styles`. Use `@spartacus/product/variants` import instead.

### Feature keys for product configurators

The feature keys that are used to lazily load the product configurator libraries in app.module.ts were available as `rulebased` and `productConfiguratorRulebased` from 3.1 onwards (respective `textfield` and `productConfiguratorTextfield` for the textfield template configurator).

In 4.0, only the longer versions `productConfiguratorRulebased` and `productConfiguratorTextfield` are possible.

Example: A configuration

```
      featureModules: {
        rulebased: {
          module: () => import('@spartacus/product-configurator/rulebased').then(
          (m) => m.RulebasedConfiguratorModule
        ),
        },
      }
```

needs to look like that in 4.0

```
      featureModules: {
        productConfiguratorRulebased: {
          module: () => import('@spartacus/product-configurator/rulebased').then(
          (m) => m.RulebasedConfiguratorModule
        ),
        },
      }
```

### Translations (i18n) changed

- Key `asm.standardSessionInProgress` was removed.

### Storage Sync mechanism

I version 4.0 we removed deprecated in version 3.0 storage sync mechanism. In previous major release we provided more powerful mechanism based on `StatePersistenceService` which can cover all use cases for synchronizing data to and from browser storage (eg. `localStorage`, `sessionStorage`) better than the removed storage sync.

What was removed:

- core of the mechanism (reducer)
- configuration (`storageSync` from `StateConfig`)
- default config and default keys (`defaultStateConfig`, `DEFAULT_LOCAL_STORAGE_KEY` and `DEFAULT_SESSION_STORAGE_KEY`)
